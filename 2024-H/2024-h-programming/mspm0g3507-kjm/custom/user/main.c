/*
┌─────────────────────────────────────────────────────────────────────────────┐
│                         MSPM0G3507 完整资源占用表                            │
├─────────────────────────────────────────────────────────────────────────────┤
│ 串口资源 (UART)                                                              │
├─────────┬─────────┬─────────┬─────────────────────────────────────────────┤
│ 串口号  │   TX    │   RX    │              用途/模块                       │
├─────────┼─────────┼─────────┼─────────────────────────────────────────────┤
│ UART_0  │  PA10   │  PA11   │  系统调试串口/蓝牙模块 (115200)				      │
│ UART_1  │  PB2    │  PB3    │  维特陀螺仪 (9600)          │
└─────────┴─────────┴─────────┴─────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ GPIO资源 (数字IO)                                                            │
├─────────┬─────────┬─────────────────────────────────────────────────────────┤
│  引脚   │  功能   │                   用途                                   │
├─────────┼─────────┼─────────────────────────────────────────────────────────┤
│  PB26   │ LED_R   │  红色LED指示灯                                          │
│  PB27   │ LED_G   │  绿色LED指示灯                                          │
│  PB22   │ LED_B   │  蓝色LED指示灯                                          │
├─────────┼─────────┼─────────────────────────────────────────────────────────┤
│  PB16   │OLED_RST │  OLED显示屏复位信号                                     │
│  PB17   │OLED_DC  │  OLED显示屏数据/命令选择                                │
│  PB20   │OLED_CS  │  OLED显示屏片选信号                                     │
├─────────┼─────────┼─────────────────────────────────────────────────────────┤
│  PB12   │  KEY1   │  按键1 (输入)                                          │
│  PB8    │  KEY2   │  按键2 (输入, 内部上拉)                                │
│  PB9    │  KEY3   │  按键3 (输入)                                          │
│  PB10   │  KEY4   │  按键4 (输入)                                          │
├─────────┼─────────┼─────────────────────────────────────────────────────────┤
│  PB4    │ENCODER_1│  编码器1 (中断输入, 上升下降沿)                          │
│  PB5    │ENCODER_2│  编码器2 (中断输入, 上升下降沿)                          │
│  PB6    │ENCODER_3│  编码器3 (中断输入, 上升下降沿)                          │
│  PB7    │ENCODER_4│  编码器4 (中断输入, 上升下降沿)                          │
│  PB19   │ENCODER_5│  编码器5 (中断输入, 上升下降沿)                          │
│  PB18   │ENCODER_6│  编码器6 (中断输入, 上升下降沿)                          │
│  PB23   │ENCODER_7│  编码器7 (中断输入, 上升下降沿)                          │
│  PB13   │ENCODER_8│  编码器8 (中断输入, 上升下降沿)                          │
├─────────┼─────────┼─────────────────────────────────────────────────────────┤
│  PA25   │HC595_DS │  74HC595数据输入                                        │
│  PA15   │HC595_SHCP│ 74HC595移位时钟                                        │
│  PA14   │HC595_STCP│ 74HC595输出锁存                                        │
└─────────┴─────────┴─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ I2C资源                                                                      │
├─────────┬─────────┬─────────┬─────────────────────────────────────────────┤
│ I2C总线 │  SCL    │  SDA    │              用途                            │
├─────────┼─────────┼─────────┼─────────────────────────────────────────────┤
│  I2C1   │  PA12   │  PA13   │  I2C设备1  pca9555 				                 │
│  I2C2   │  PA8    │  PA26   │  I2C设备2  mpu6050				                 │
│  I2C3   │  PA29   │  PA30   │  I2C设备3  空							                 │
└─────────┴─────────┴─────────┴─────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ SPI资源                                                                      │
├─────────┬─────────┬─────────┬─────────┬─────────────────────────────────────┤
│ SPI总线 │  SCLK   │  MOSI   │  MISO   │              用途                    │
├─────────┼─────────┼─────────┼─────────┼─────────────────────────────────────┤
│  SPI1   │  PA17   │  PB15   │  PA16   │  OLED显示屏 (1MHz, Mode3)           │
└─────────┴─────────┴─────────┴─────────┴─────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ PWM资源                                                                      │
├─────────┬─────────┬─────────┬─────────────────────────────────────────────┤
│ PWM模块 │  CCP0   │  CCP1   │              用途                            │
├─────────┼─────────┼─────────┼─────────────────────────────────────────────┤
│ TIMA0   │  PA0    │  PA1    │  左轮电机通道一，二 (分频8, 计数3000)        │
│ TIMG8   │  PA7    │  PA22   │  右轮电机通道一，二 (分频8, 计数3000)        │
│ TIMG7   │  PA23   │  PA27   │  蜂鸣器PWM (LFCLK时钟源)                    │
└─────────┴─────────┴─────────┴─────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│ 调试接口                                                                     │
├─────────┬─────────────────────────────────────────────────────────────────┤
│  SWCLK  │  PA20   │  SWD调试时钟                                           │
│  SWDIO  │  PA19   │  SWD调试数据                                           │
└─────────┴─────────────────────────────────────────────────────────────────┘
*/


#include "common_include.h"
#include "log_config.h" // 日志配置
#include "log.h"

void system_init(void) 
{
    SYSCFG_DL_init();
		beep_init();
		systick_init();
}

void main_task_init(void) 
{
		wit_imu_init();
		bluetooth_init();
    menu_init_and_create();
    car_init();
		gray_detection_init();
		create_periodic_event_task(); // 初始化任务调度器
}

void test_task(void) 
{
	vl53l1_test();
}

int main(void) 
{
    system_init();
    
#if UNIT_TEST_MODE    // 是否使能单元测试功能
		test_task();
		while (1) {
		
		}
#else
		main_task_init();
#endif

    while (1) {
        periodic_event_task_process(); // 处理所有任务
    }

    return 0;
}


void HardFault_Handler(void) 
{
    log_e("!!! Unhandled Interrupt HardFault_Handler !!!\n");
    
    play_alert_blocking(3, COLOR_RED);
    
    while (1)
    {
    }
}

